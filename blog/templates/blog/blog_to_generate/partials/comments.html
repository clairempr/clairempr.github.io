<div class="mt-5 mx-4">
  <h3 class="pt-3">Comments</h3>

  <form method="POST" action="{{ staticman_url }}" class="w-50 text-start">
    <input name="options[redirect]" type="hidden" value="https://clairempr.github.io/pages/{{ html_filename }}">
    <input type="hidden" name="options[reCaptcha][siteKey]" value="{{ reCaptcha_site_key }}">
    <input type="hidden" name="options[reCaptcha][secret]" value="{{ reCaptcha_secret_key }}">
    <!-- e.g. "2016-01-02-this-is-a-post" -->
    <input name="options[slug]" type="hidden" value="{{ story_title|slugify }}">

    <label for="fields[name]" class="form-label my-2">Name</label>
    <input id="fields[name]" name="fields[name]" type="text" class="form-control mb-2">

    <label for="fields[message]" class="form-label my-2">Message</label>
    <textarea id="fields[message]" name="fields[message]" class="form-control mb-2"></textarea>
    <div id="reCaptcha" class="g-recaptcha" data-sitekey="{{ reCaptcha_site_key }}"></div>

    <button type="submit" class="btn btn-outline-dark my-3 py-2">Submit</button>
  </form>
</div>

<div class="comments mt-5 mx-4">
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script>

  function getComment(fileUrl) {
    $.get(fileUrl, function (comment) {

      if (comment) {
        let id, name, email, message, dateStr = '';

        const lines = comment.split(/\r\n|\n/);
        for (let i = 0; i < lines.length - 1; i++) {

          let line = lines[i];
          if (line.startsWith('_id: ')) {
            id = line.replace('_id: ', '');
          }
          else if (line.startsWith('name: ')) {
            name = line.replace('name: ', '');
          }
          else if (line.startsWith('email: ')) {
            email = line.replace('email: ', '');
          }
          else if (line.startsWith('message: ')) {
            message = line.replace('message: ', '');
          }
          else if (line.startsWith('date: ')) {
            dateStr = line.replace("date: ", "");
            dateStr = dateStr.replaceAll("'", "");
          }
        }

        // Append comment div
        let commentId = 'comment_' + id;
        $(".comments").append('<div id="' + commentId + '" class="comment"></div>');

        // Append comment contents
        let commentDiv = $("#" + commentId);
        let nameElement = '<p class="comment-name">' + name + "</p>";
        const date = new Date(dateStr);
        let dateElement = '<p class="comment-date">' + date + "</p>";
        let messageElement = '<p class="comment-message">' + message + "</p>";
        commentDiv.append(nameElement, dateElement, messageElement);
      }
    });
  }

  $(function () {
    /*
      Read a list of the comments for this page from the GitHub repo
    */
    const ymlFilesListUrl = "{{comments_url}}{{ story_title|slugify }}/yml_files.txt";

    $.get(ymlFilesListUrl, function (filesList) {

      if (filesList) {
        const lines = filesList.split(/\r\n|\n/);
        for (let i = 0; i < lines.length - 1; i++) {

          const ymlFileUrl = "{{comments_url}}{{ story_title|slugify }}/" + lines[i];
          getComment(ymlFileUrl);
        }
      }

    });

  });
</script>